<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Find the nearest hospitals, police stations, and fire stations in Dublin, Ireland">
    <meta name="theme-color" content="#FF385C">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Emergency Locator">
    
    <title>Emergency Services Locator - Dublin</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512x512.png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>
                        <span class="header-icon">üöë</span>
                        Emergency Services Locator
                    </h1>
                    <p>Find the nearest hospitals, police stations, and fire stations in Dublin, Ireland</p>
                </div>
                <div id="connectionStatus" class="connection-status online" title="Connection Status">
                    <i class="fas fa-wifi"></i>
                    <span>Online</span>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Map Section -->
            <div class="map-container">
                <div id="map"></div>
                <div class="map-overlay">
                    <h6><i class="fas fa-map-marker-alt"></i> Your Location</h6>
                    <div class="coordinates">
                        <div>Lat: <span id="currentLat">53.3365</span></div>
                        <div>Lng: <span id="currentLng">-6.2856</span></div>
                        <button class="btn-copy-coords" onclick="copyCoordinates()" title="Copy coordinates">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                
                <!-- LOCATION SEARCH - AT TOP (Most Important) -->
                <div class="control-section">
                    <div class="section-title">
                        <span class="section-icon"><i class="fas fa-search-location"></i></span>
                        Find Your Location
                    </div>
                    
                    <!-- Address Search -->
                    <label class="input-label">
                        <i class="fas fa-map-pin"></i> Enter Address
                    </label>
                    <div class="address-search-group">
                        <input 
                            type="text" 
                            class="location-input" 
                            id="addressInput" 
                            placeholder="e.g., Cork Street Dublin 8"
                            autocomplete="off"
                            onkeypress="if(event.key === 'Enter') searchAddress()"
                        >
                        <button class="btn-custom btn-success-custom" onclick="searchAddress()" title="Search">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <!-- GPS Button -->
                    <button class="btn-custom btn-primary-custom" onclick="useCurrentGPS()">
                        <i class="fas fa-crosshairs"></i> Use My GPS Location
                    </button>
                    
                    <!-- Manual Coordinates (Collapsed by default) -->
                    <details style="margin-top: 16px;">
                        <summary style="cursor: pointer; font-size: 0.875rem; color: #767676; font-weight: 600; padding: 8px 0;">
                            <i class="fas fa-caret-right"></i> Advanced: Enter Coordinates
                        </summary>
                        <div style="margin-top: 12px;">
                            <div class="location-input-group">
                                <input type="number" class="location-input" id="inputLat" placeholder="Latitude" step="0.0001" value="53.3365">
                                <input type="number" class="location-input" id="inputLng" placeholder="Longitude" step="0.0001" value="-6.2856">
                            </div>
                        </div>
                    </details>
                    
                    <div class="draggable-hint">
                        <i class="fas fa-hand-pointer"></i>
                        <span>Drag the üìç pin on map to set location instantly!</span>
                    </div>
                </div>

                <!-- QUICK FILTERS -->
                <div class="control-section">
                    <div class="section-title">
                        <span class="section-icon"><i class="fas fa-filter"></i></span>
                        Quick Filters
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="btn-custom btn-hospital" onclick="filterByType('hospital')">
                            üè• Hospitals
                        </button>
                        <button class="btn-custom btn-police" onclick="filterByType('police')">
                            üëÆ Police
                        </button>
                        <button class="btn-custom btn-fire" onclick="filterByType('fire')">
                            üöí Fire
                        </button>
                        <button class="btn-custom btn-all" onclick="showAllServices()">
                            üåç All
                        </button>
                    </div>
                    
                    <!-- Clear Filters Button -->
                    <button class="btn-custom" onclick="clearAllFilters()" style="background: #6c757d; color: white; margin-top: 10px;">
                        <i class="fas fa-times-circle"></i> Clear All Filters
                    </button>
                </div>

                <!-- ROUTE NAVIGATION -->
                <div class="control-section">
                    <div class="section-title">
                        <span class="section-icon"><i class="fas fa-route"></i></span>
                        Route Navigation
                    </div>
                    <p style="font-size: 0.875rem; color: #767676; margin-bottom: 12px;">
                        Click "Get Directions" on any service marker to see the route from your location.
                    </p>
                    <button class="btn-custom" onclick="clearRoute()" style="background: #9CA3AF; color: white;">
                        <i class="fas fa-eraser"></i> Clear Route
                    </button>
                </div>

                <!-- SEARCH TOOLS -->
                <div class="control-section">
                    <div class="section-title">
                        <span class="section-icon"><i class="fas fa-search"></i></span>
                        Search Nearby
                    </div>
                    
                    <!-- Nearest Search -->
                    <div style="margin-bottom: 16px;">
                        <label class="input-label">Find Nearest</label>
                        <div style="display: flex; gap: 10px;">
                            <select class="location-input" id="nearestLimit" style="flex: 1;">
                                <option value="3">3 Services</option>
                                <option value="5" selected>5 Services</option>
                                <option value="10">10 Services</option>
                                <option value="15">15 Services</option>
                            </select>
                            <button class="btn-custom btn-primary-custom" onclick="findNearest()" style="width: auto; margin: 0; padding: 14px 24px;">
                                <i class="fas fa-location-arrow"></i> Find
                            </button>
                        </div>
                    </div>

                    <!-- Radius Search -->
                    <div>
                        <label class="input-label">Search Radius</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" class="location-input" id="radiusInput" value="5" min="1" max="50" style="flex: 1;" placeholder="km">
                            <button class="btn-custom btn-success-custom" onclick="searchWithinRadius()" style="width: auto; margin: 0; padding: 14px 24px;">
                                <i class="fas fa-circle"></i> Search
                            </button>
                        </div>
                    </div>
                </div>

                <!-- STATISTICS -->
                <div class="control-section">
                    <div class="section-title">
                        <span class="section-icon"><i class="fas fa-chart-pie"></i></span>
                        Statistics
                    </div>
                    <div class="stats-grid" id="statsContainer">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- RESULTS -->
                <div id="resultsContainer"></div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <!-- Custom JavaScript -->
    <script src="/static/js/map.js"></script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Register service worker for offline functionality and PWA features
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Register the service worker script
                navigator.serviceWorker.register('/static/js/service-worker.js')
                    .then((registration) => {
                        console.log('‚úÖ Service Worker registered:', registration.scope);
                        
                        // Listen for when a new service worker version is available
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            // Monitor the new worker's installation progress
                            newWorker.addEventListener('statechange', () => {
                                // If new worker is installed and old one is still active
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('üîÑ New service worker available');
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('‚ùå Service Worker registration failed:', error);
                    });
            });
        }
        
        // PWA Install Prompt Handler
        // Stores the browser's install prompt event so we can show it later
        let deferredPrompt;
        
        // Listen for when browser wants to show install prompt
        // This happens when the app meets PWA criteria (manifest, service worker, etc.)
        window.addEventListener('beforeinstallprompt', (e) => {
            // Stop browser from showing default install banner automatically
            e.preventDefault();
            // Save the event so we can trigger it manually when user clicks install button
            deferredPrompt = e;
            console.log('üì± PWA install prompt available');
        });
        
        // Detect when user successfully installs the PWA
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA installed successfully');
            // Clear the deferred prompt since installation is complete
            deferredPrompt = null;
        });
        
        // Function to show install prompt when user clicks install button
        async function installPWA() {
            if (deferredPrompt) {
                // Show the browser's install prompt dialog
                deferredPrompt.prompt();
                // Wait for user to accept or dismiss
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User ${outcome} the install prompt`);
                // Clear since prompt can only be used once
                deferredPrompt = null;
            }
        }
        
        // Check if app is currently running as installed PWA
        // Returns true if app was launched from home screen icon
        function isPWA() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone || 
                   document.referrer.includes('android-app://');
        }
        
        // Update connection status indicator in header
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                // Check browser's online status
                const isOnline = navigator.onLine;
                
                // Verify connection by making actual HTTP request to API
                fetch('/api/services/statistics/', { method: 'HEAD', cache: 'no-cache' })
                    .then(() => {
                        statusEl.className = 'connection-status online';
                        statusEl.innerHTML = '<i class="fas fa-wifi"></i><span>Online</span>';
                    })
                    .catch(() => {
                        statusEl.className = 'connection-status offline';
                        statusEl.innerHTML = '<i class="fas fa-wifi-slash"></i><span>Offline</span>';
                    });
                
                // Update UI immediately based on browser's online status
                if (isOnline) {
                    statusEl.className = 'connection-status online';
                    statusEl.innerHTML = '<i class="fas fa-wifi"></i><span>Online</span>';
                } else {
                    statusEl.className = 'connection-status offline';
                    statusEl.innerHTML = '<i class="fas fa-wifi-slash"></i><span>Offline</span>';
                }
            }
        }
        
        // Listen for when browser detects network connection restored
        window.addEventListener('online', () => {
            console.log('‚úÖ Back online');
            // Small delay to ensure network is actually ready
            setTimeout(updateConnectionStatus, 100);
            if (typeof showAlert === 'function') {
                setTimeout(() => showAlert('‚úÖ Connection restored', 'success'), 200);
            }
        });
        
        // Listen for when browser detects network connection lost
        window.addEventListener('offline', () => {
            console.log('‚ùå Gone offline');
            updateConnectionStatus();
            if (typeof showAlert === 'function') {
                showAlert('‚ö†Ô∏è You are offline. Some features may be limited.', 'info');
            }
        });
        
        // Check connection status when page loads
        setTimeout(updateConnectionStatus, 500);
        
        // Check connection status every 10 seconds to keep it accurate
        setInterval(updateConnectionStatus, 10000);
    </script>
</body>
</html>